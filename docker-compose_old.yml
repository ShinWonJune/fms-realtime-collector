services:
  # 백필 스케줄러 (3일마다 자동 실행)
  backfill-scheduler:
    build:
      context: .
      dockerfile: scheduler.Dockerfile
    environment:
      # 외부 Kafka/MinIO 서버 설정
      KAFKA_BROKERS: "10.79.1.1:9094"
      KAFKA_TOPIC: "fms-temphum"
      KAFKA_GROUP_ID: "backfill-loader"
      MINIO_ENDPOINT: "10.79.1.0:9000"
      MINIO_ACCESS_KEY: "gxQHjrQB9JHKtlIlSYNe"
      MINIO_SECRET_KEY: "Vjsd5McgcZQ9NJ3NS9sThl7gIo1ZXVRfNfLwVJ3N"
      MINIO_BUCKET: "fms-temphum"
      MINIO_SECURE: "false"
      # 스케줄러 설정
      RUN_ON_START: "true"  # true로 설정시 시작할 때 바로 실행
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 300s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 수동 백필 로더 (필요시 수동 실행)
  backfill-loader:
    build: ./backfill-loader
    environment:
      # 외부 Kafka/MinIO 서버 설정
      KAFKA_BROKERS: "10.79.1.1:9094"
      KAFKA_TOPIC: "fms-temphum"
      KAFKA_GROUP_ID: "backfill-loader"
      MINIO_ENDPOINT: "10.79.1.0:9000"
      MINIO_ACCESS_KEY: "ElQgWuV9dGLLc2VKeGAd"
      MINIO_SECRET_KEY: "P70RNNJehlgTFL5zOpsIdRwKqZYuxINRdM1aEVBj"
      MINIO_BUCKET: "temphum"
      MINIO_SECURE: "false"
    restart: "no"  # 백필은 한 번만 실행
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    # 프로파일을 사용하여 수동 실행 가능하게 설정
    profiles:
      - backfill

